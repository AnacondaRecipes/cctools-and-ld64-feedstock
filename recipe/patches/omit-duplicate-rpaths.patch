From b70115371bc66cfc6698f979d3cbee6d185647b3 Mon Sep 17 00:00:00 2001
From: Eric Lundby <Eric.Lundby@gmail.com>
Date: Mon, 30 Jun 2025 14:47:33 -0600
Subject: [PATCH 1/1] omit-duplicate-rpaths

---
 cctools/ld64/src/ld/Options.cpp | 13 ++++++++++++-
 cctools/ld64/src/ld/Options.h   |  2 ++
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/cctools/ld64/src/ld/Options.cpp b/cctools/ld64/src/ld/Options.cpp
index 5b8c755..077c6c7 100644
--- a/cctools/ld64/src/ld/Options.cpp
+++ b/cctools/ld64/src/ld/Options.cpp
@@ -46,6 +46,8 @@
 #include <vector>
 #include <map>
 #include <sstream>
+#include <set>
+#include <stdio.h>
 
 #include "ld.hpp"
 #include "Options.h"
@@ -3509,7 +3511,16 @@ void Options::parse(int argc, const char* argv[])
 			}
 			else if ( strcmp(arg, "-rpath") == 0 ) {
 				const char* path = checkForNullArgument(arg, argv[++i]);
-				fRPaths.push_back(path);
+
+				std::string rpath_str = std::string(path);
+
+				if (fRPathsSet.count(rpath_str)) {
+					fprintf(stderr, "ld: warning: duplicate -rpath '%s' ignored\n", rpath_str.c_str());
+				}
+				else {
+					fRPathsSet.insert(rpath_str);
+					fRPaths.push_back(path);
+				}
 			}
 			else if ( strcmp(arg, "-read_only_stubs") == 0 ) {
 				fReadOnlyx86Stubs = true;
diff --git a/cctools/ld64/src/ld/Options.h b/cctools/ld64/src/ld/Options.h
index f36a4ef..2f5870d 100644
--- a/cctools/ld64/src/ld/Options.h
+++ b/cctools/ld64/src/ld/Options.h
@@ -33,6 +33,7 @@
 #endif 
 
 #include <vector>
+#include <set>
 #include <unordered_set>
 #include <unordered_map>
 
@@ -664,6 +665,7 @@ private:
 	std::vector<const char*>			fSubLibraries;
 	std::vector<const char*>			fAllowableClients;
 	std::vector<const char*>			fRPaths;
+	std::set<std::string>				fRPathsSet; // For efficient duplicate detection
 	const char*							fClientName;
 	const char*							fUmbrellaName;
 	const char*							fInitFunctionName;
-- 
2.45.2

