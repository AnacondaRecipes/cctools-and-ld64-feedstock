From a489b296b895216167ed6b44833731d448b7b5db Mon Sep 17 00:00:00 2001
From: Isuru Fernando <isuruf@gmail.com>
Date: Wed, 30 Sep 2020 21:01:34 -0500
Subject: [PATCH 2/2] run ldid after install_name_tool

---
 cctools/misc/install_name_tool.c | 26 +++++++++++++++++++++++++-
 1 file changed, 25 insertions(+), 1 deletion(-)

diff --git a/cctools/misc/install_name_tool.c b/cctools/misc/install_name_tool.c
index 34d063d..e976ede 100644
--- a/cctools/misc/install_name_tool.c
+++ b/cctools/misc/install_name_tool.c
@@ -131,6 +131,8 @@ char **envp)
     uint32_t narchs;
     char *input;
     char *output;
+    char *ldidcommand;
+    int isarm64;
 
 	output = NULL;
 	progname = argv[0];
@@ -312,11 +314,33 @@ char **envp)
 	if(errors)
 	    exit(EXIT_FAILURE);
 
+    isarm64 = 0;
+    for (i = 0; i < narchs; i++) {
+        if (archs[i].object->mh != NULL) {
+            if (archs[i].object->mh->cputype == CPU_TYPE_ARM64) {
+                isarm64 = 1;
+            }
+        } else {
+            if (archs[i].object->mh64->cputype == CPU_TYPE_ARM64) {
+                isarm64 = 1;
+            }
+	    }
+    }
+
 	if(output != NULL)
 	    writeout(archs, narchs, output, 0777, TRUE, FALSE, FALSE, FALSE,
 		     NULL);
-	else
+	else {
 	    write_on_input(archs, narchs, input);
+        output = input;
+    }
+
+    if (isarm64 == 1) {
+        ldidcommand = allocate(strlen(output) + 9);
+        memcpy(ldidcommand, "ldid -S ", 8);
+        memcpy(ldidcommand + 8, input, strlen(output) + 1);
+        system(ldidcommand);
+    }
 
 	if(errors)
 	    return(EXIT_FAILURE);
-- 
2.28.0

